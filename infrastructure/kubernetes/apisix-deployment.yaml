---
apiVersion: v1
kind: ConfigMap
metadata:
  name: apisix-config
  namespace: url-shorten
data:
  config.yaml: |
    apisix:
      node_listen: 9080
      enable_admin: true
      enable_admin_cors: true
    
    deployment:
      role: traditional
      role_traditional:
        config_provider: etcd
      
      admin:
        admin_listen:
          ip: 0.0.0.0
          port: 9180
        allow_admin:
          - 0.0.0.0/0
        admin_key:
          - name: "admin"
            key: edd1c9f034335f136f87ad84b625c8f1
            role: admin
      
      etcd:
        host:
          - "http://etcd:2379"
        prefix: "/apisix"
        timeout: 30
    
    plugin_attr:
      prometheus:
        export_addr:
          ip: "0.0.0.0"
          port: 9091
---
apiVersion: v1
kind: Service
metadata:
  name: etcd
  namespace: url-shorten
  labels:
    app: etcd
spec:
  type: ClusterIP
  ports:
    - port: 2379
      targetPort: 2379
      protocol: TCP
      name: etcd-client
  selector:
    app: etcd
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: etcd
  namespace: url-shorten
spec:
  replicas: 1
  selector:
    matchLabels:
      app: etcd
  template:
    metadata:
      labels:
        app: etcd
    spec:
      containers:
        - name: etcd
          image: quay.io/coreos/etcd:v3.5.11
          imagePullPolicy: Always
          command:
            - /usr/local/bin/etcd
            - --data-dir=/etcd-data
            - --name=etcd0
            - --initial-advertise-peer-urls=http://etcd:2380
            - --listen-peer-urls=http://0.0.0.0:2380
            - --advertise-client-urls=http://etcd:2379
            - --listen-client-urls=http://0.0.0.0:2379
            - --initial-cluster=etcd0=http://etcd:2380
            - --initial-cluster-state=new
            - --initial-cluster-token=etcd-cluster
          env:
            - name: ETCDCTL_API
              value: "3"
          ports:
            - containerPort: 2379
              name: client
            - containerPort: 2380
              name: peer
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          livenessProbe:
            httpGet:
              path: /health
              port: 2379
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: 2379
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
---
apiVersion: v1
kind: Service
metadata:
  name: apisix-gateway
  namespace: url-shorten
  labels:
    app: apisix
spec:
  type: NodePort
  ports:
    - port: 9080
      targetPort: 9080
      nodePort: 30900
      protocol: TCP
      name: http
    - port: 9180
      targetPort: 9180
      nodePort: 30901
      protocol: TCP
      name: admin
    - port: 9091
      targetPort: 9091
      nodePort: 30902
      protocol: TCP
      name: metrics
  selector:
    app: apisix
---
apiVersion: v1
kind: Service
metadata:
  name: apisix-admin
  namespace: url-shorten
  labels:
    app: apisix
spec:
  type: NodePort
  ports:
    - port: 9000
      targetPort: 9000
      nodePort: 30910
      protocol: TCP
      name: dashboard
  selector:
    app: apisix-dashboard
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: apisix
  namespace: url-shorten
spec:
  replicas: 1
  selector:
    matchLabels:
      app: apisix
  template:
    metadata:
      labels:
        app: apisix
    spec:
      containers:
        - name: apisix
          image: apache/apisix:3.7.0-debian
          ports:
            - containerPort: 9080
              name: http
            - containerPort: 9180
              name: admin
            - containerPort: 9091
              name: metrics
          env:
            - name: APISIX_STAND_ALONE
              value: "false"
          volumeMounts:
            - name: apisix-config
              mountPath: /usr/local/apisix/conf/config.yaml
              subPath: config.yaml
          livenessProbe:
            tcpSocket:
              port: 9080
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 3
          readinessProbe:
            tcpSocket:
              port: 9080
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 2
            failureThreshold: 3
          resources:
            requests:
              memory: "256Mi"
              cpu: "250m"
            limits:
              memory: "512Mi"
              cpu: "500m"
      volumes:
        - name: apisix-config
          configMap:
            name: apisix-config
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: apisix-dashboard-config
  namespace: url-shorten
data:
  conf.yaml: |
    conf:
      listen:
        host: 0.0.0.0
        port: 9000
      etcd:
        endpoints:
          - http://etcd:2379
      log:
        error_log:
          level: warn
          file_path: /dev/stderr
        access_log:
          file_path: /dev/stdout
    authentication:
      secret: secret
      expire_time: 3600
      users:
        - username: admin
          password: admin
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: apisix-dashboard
  namespace: url-shorten
spec:
  replicas: 1
  selector:
    matchLabels:
      app: apisix-dashboard
  template:
    metadata:
      labels:
        app: apisix-dashboard
    spec:
      initContainers:
        - name: wait-for-etcd
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for ETCD to be ready..."
              until nc -z etcd 2379; do
                echo "ETCD is unavailable - sleeping"
                sleep 2
              done
              echo "ETCD is ready - starting Dashboard"
      containers:
        - name: apisix-dashboard
          image: apache/apisix-dashboard:3.0.1-alpine
          ports:
            - containerPort: 9000
              name: dashboard
          volumeMounts:
            - name: dashboard-config
              mountPath: /usr/local/apisix-dashboard/conf/conf.yaml
              subPath: conf.yaml
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "200m"
      volumes:
        - name: dashboard-config
          configMap:
            name: apisix-dashboard-config
